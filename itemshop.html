<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fortnite Item Shop</title>
  <link rel="icon" type="image/png" href="https://fortnite-api.com/images/vbuck.png" />
  <style>
    :root{
      --bg:#0c0c0d; 
      --panel:#111113; 
      --text:#e6e6e8; 
      --muted:#b6b6bb;
      --accent:#e11d2e; 
      --accent-700:#960b17; 
      --border:#1e1f22; 
      --radius:14px;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --font:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell,"Noto Sans","Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";
    }

    * { box-sizing:border-box; }
    html, body { height:100%; margin:0; }
    
    body {
      background:linear-gradient(180deg,#0a0a0a 0%,#0e0e10 100%);
      color:var(--text);
      font-family:var(--font);
      line-height:1.5;
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
      padding:20px;
    }

    .container {
      max-width:1400px;
      margin:0 auto;
    }

    header {
      text-align:center;
      margin-bottom:40px;
    }

    h1 {
      font-size:clamp(32px,4vw,48px);
      font-weight:800;
      letter-spacing:.3px;
      margin:0 0 12px;
      background:linear-gradient(135deg, var(--accent) 0%, #ff4d5a 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }

    .subtitle {
      color:var(--muted);
      font-size:14px;
      margin:0;
    }

    .loading {
      text-align:center;
      padding:60px 20px;
      color:var(--muted);
      font-size:18px;
    }

    .error {
      text-align:center;
      padding:40px 20px;
      color:#f87171;
      font-size:16px;
      background:linear-gradient(180deg,#111113,#0f0f11);
      border:1px solid var(--border);
      border-radius:var(--radius);
      margin:20px 0;
    }

    /* Group styling */
    .group {
      margin-bottom:40px;
    }

    .group-title {
      font-size:20px;
      font-weight:800;
      margin:0 0 16px;
      padding:10px 16px;
      border:1px solid var(--border);
      border-radius:12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:linear-gradient(180deg,#131315,#101013);
      box-shadow:var(--shadow);
    }

    .group-title .count {
      font-weight:700;
      color:var(--muted);
      font-size:15px;
      margin-left:4px;
    }

    .items-grid {
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));
      gap:16px;
    }

    @media (max-width:768px) {
      .items-grid {
        grid-template-columns:repeat(auto-fill, minmax(160px, 1fr));
        gap:12px;
      }
    }

    .item {
      background:linear-gradient(180deg,#111113,#0f0f11);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--shadow);
      transition:transform 0.2s ease, border-color 0.2s ease;
      cursor:pointer;
      text-align:center;
    }

    .item:hover {
      transform:translateY(-4px);
      border-color:var(--accent);
    }

    .item > img {
      width:100%;
      height:200px;
      object-fit:contain;
      border-radius:25px;
      background:#3131310a;
      margin-bottom:12px;
    }

    .item-name {
      font-weight:700;
      font-size:14px;
      color:var(--text);
      margin:0 0 6px;
      min-height:38px;
      display:flex;
      align-items:center;
      justify-content:center;
      line-height:1.3;
    }

    .item-artist {
      font-size:12px;
      color:var(--muted);
      margin:0 0 8px;
      font-style:italic;
    }

    .item-description {
      font-size:11px;
      color:var(--muted);
      margin:0 0 8px;
      opacity:0.8;
    }

    .item-price {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:4px;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid var(--accent);
      background:linear-gradient(180deg,var(--accent),var(--accent-700));
      font-weight:800;
      font-size:14px;
      color:white;
      line-height:1;
    }

    .item-price img {
      width:25px;
      height:35px;
      max-width:25px;
      max-height:35px;
      object-fit:contain;
      background-color:transparent;
      flex-shrink:0;
    }

    /* Rarity borders */
    .item[data-rarity="legendary"] { border-color:#d97706; }
    .item[data-rarity="epic"] { border-color:#a855f7; }
    .item[data-rarity="rare"] { border-color:#3b82f6; }
    .item[data-rarity="uncommon"] { border-color:#22c55e; }
    .item[data-rarity="common"] { border-color:#6b7280; }
    .item[data-rarity="mythic"] { border-color:#fbbf24; box-shadow:0 0 10px rgba(251,191,36,0.3); }
    .item[data-rarity="exotic"] { border-color:#14b8a6; box-shadow:0 0 10px rgba(20,184,166,0.3); }
    .item[data-rarity="transcendent"] { border-color:#ec4899; box-shadow:0 0 10px rgba(236,72,153,0.3); }
    .item[data-rarity="gaminglegends"] { border-color:#8b5cf6; }
    .item[data-rarity="dark"] { border-color:#7c3aed; }
    .item[data-rarity="frozen"] { border-color:#06b6d4; }
    .item[data-rarity="lava"] { border-color:#f97316; }
    .item[data-rarity="marvel"] { border-color:#dc2626; }
    .item[data-rarity="dc"] { border-color:#1e40af; }
    .item[data-rarity="icon"] { border-color:#facc15; }
    .item[data-rarity="starwars"] { border-color:#fbbf24; }
    .item[data-rarity="shadow"] { border-color:#4b5563; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Fortnite Item Shop</h1>
      <p class="subtitle">Aktualna ponuka itemov</p>
    </header>

    <div id="shop">
      <div class="loading">Nacitavam data...</div>
    </div>
  </div>

  <script>
    const SHOP_JSON_URL = "https://fortnite-api.com/v2/shop";
    const COSMETICS_JSON_URL = "https://fortnite-api.com/v2/cosmetics";

    const TYPE_NAMES = {
      'outfit': 'Outfits',
      'backpack': 'Back Blings',
      'pickaxe': 'Pickaxes',
      'glider': 'Gliders',
      'wrap': 'Wraps',
      'emote': 'Emotes',
      'emoji': 'Emojis',
      'spray': 'Sprays',
      'loadingscreen': 'Loading Screens',
      'contrail': 'Contrails',
      'music': 'Music Packs',
      'banner': 'Banners',
      'toy': 'Toys',
      'pet': 'Pets',
      'sidekick': 'Sidekicks',
      'shoes': 'Shoes',
      'kicks': 'Kicks',
      'itemwrap': 'Item Wraps',
      'bundle': 'Bundles',
      'aura': 'Auras',
      'guitar': 'Guitars',
      'bass': 'Bass',
      'drum': 'Drums',
      'microphone': 'Microphones',
      'keytar': 'Keytars',
      'tracks': 'Jam Tracks',
      'other': 'Other'
    };

    function cleanItemName(name) {
      if (!name) return "Neznamy item";
      
      name = name.replace(/^\[Virtual\]\s*/i, '');
      name = name.replace(/^\[VIRTUAL\]\s*/i, '');
      name = name.replace(/^\d+x\s+/i, '');
      name = name.replace(/^\d+\s+x\s+/i, '');
      
      // Odstráň ", 1 x Názov" pattern (po čiarke)
      name = name.replace(/,\s*\d+\s+x\s+.+$/i, '');
      
      name = name.replace(/\s+for\s+\d+\s+MtxCurrency/gi, '');
      name = name.replace(/\s+for\s+\d+\s+V-Bucks/gi, '');
      name = name.replace(/\s+Bundle\s+Bundle$/i, ' Bundle');
      
      return name.trim();
    }

    function getItemDescription(entry, cosmeticsMap) {
      // Použijeme items alebo brItems
      const itemsList = entry.items || entry.brItems || [];
      
      if (itemsList.length <= 1) {
        return '';
      }
      
      console.log('Entry has multiple items:', itemsList.length, itemsList);
      const types = new Set();
      
      itemsList.forEach(item => {
        console.log('Checking item:', item.id, 'Has in map:', cosmeticsMap.has(item.id));
        if (item.id && cosmeticsMap.has(item.id)) {
          const cosmetic = cosmeticsMap.get(item.id);
          console.log('Cosmetic details:', cosmetic.type);
          if (cosmetic.type && cosmetic.type.value) {
            const typeName = cosmetic.type.value.toLowerCase();
            console.log('Type name:', typeName);
            
            const typeMap = {
              'outfit': 'Skin',
              'backpack': 'Back Bling',
              'pickaxe': 'Pickaxe',
              'glider': 'Glider',
              'wrap': 'Wrap',
              'emote': 'Emote'
            };
            
            if (typeMap[typeName]) {
              types.add(typeMap[typeName]);
              console.log('Added type:', typeMap[typeName]);
            }
          }
        }
      });
      
      console.log('Total types found:', types.size, Array.from(types));
      if (types.size >= 2) {
        const result = Array.from(types).join(' + ');
        console.log('Returning description:', result);
        return result;
      }
      
      return '';
    }

    function extractSetName(item) {
      let name = item.name;
      name = name.replace(/\s+(Outfit|Skin|Back Bling|Pickaxe|Glider|Wrap|Bundle)$/i, '');
      name = name.replace(/'s$/i, '');
      return name.trim();
    }

    function groupItemsIntoSets(groupedItems, allEntries) {
      const sets = {};
      const collections = {};
      const itemsInSets = new Set();
      
      allEntries.forEach((entry, entryIndex) => {
        if (entry.layout && entry.layout.id && entry.layout.name) {
          const collectionId = entry.layout.id;
          const collectionName = entry.layout.name;
          
          if (!collections[collectionId]) {
            collections[collectionId] = {
              name: collectionName,
              items: []
            };
          }
          
          collections[collectionId].items.push({
            entryIndex: entryIndex,
            entry: entry
          });
        }
      });
      
      const typesToCheck = ['outfit', 'backpack', 'pickaxe', 'glider', 'wrap', 'sidekick', 'shoes', 'kicks'];
      
      typesToCheck.forEach(type => {
        if (!groupedItems[type]) return;
        
        groupedItems[type].forEach((item, index) => {
          const setName = extractSetName(item);
          let matchingItems = [{...item, type: type, originalIndex: index}];
          
          typesToCheck.forEach(otherType => {
            if (otherType === type || !groupedItems[otherType]) return;
            
            groupedItems[otherType].forEach((otherItem, otherIndex) => {
              const otherSetName = extractSetName(otherItem);
              
              if (setName.toLowerCase() === otherSetName.toLowerCase() && setName.length > 3) {
                matchingItems.push({...otherItem, type: otherType, originalIndex: otherIndex});
                itemsInSets.add(`${otherType}-${otherIndex}`);
              }
            });
          });
          
          if (matchingItems.length >= 2) {
            itemsInSets.add(`${type}-${index}`);
            
            if (!sets[setName]) {
              sets[setName] = matchingItems;
            } else {
              matchingItems.forEach(newItem => {
                const exists = sets[setName].some(existing => 
                  existing.type === newItem.type && existing.name === newItem.name
                );
                if (!exists) {
                  sets[setName].push(newItem);
                }
              });
            }
          }
        });
      });
      
      return { sets, itemsInSets, collections };
    }

    async function loadData() {
      const shopContainer = document.getElementById('shop');
      shopContainer.innerHTML = "Nacitavam data...";

      try {
        const shopResponse = await fetch(SHOP_JSON_URL, {
          headers: { "Authorization": "" }
        });
        
        if (!shopResponse.ok) {
          throw new Error(`Chyba pri nacitani Shop API: ${shopResponse.status}`);
        }
        
        const shopData = await shopResponse.json();

        if (!shopData?.data?.entries) {
          throw new Error("Neocakavana struktura dat");
        }

        const shopEntries = shopData.data.entries;

        const cosmeticsResponse = await fetch(COSMETICS_JSON_URL, {
          headers: { "Authorization": "" }
        });
        
        if (!cosmeticsResponse.ok) {
          throw new Error(`Chyba pri nacitani Cosmetics API: ${cosmeticsResponse.status}`);
        }
        
        const cosmeticsData = await cosmeticsResponse.json();

        if (!cosmeticsData?.data?.br) {
          throw new Error("Neocakavana struktura cosmetics dat");
        }

        const allCosmetics = cosmeticsData.data.br;

        const cosmeticsMap = new Map();
        allCosmetics.forEach(cosmetic => {
          cosmeticsMap.set(cosmetic.id, cosmetic);
        });

        shopContainer.innerHTML = "";

        if (shopEntries.length === 0) {
          shopContainer.innerHTML = "<p class='error'>Dnes ziadne polozky v obchode!</p>";
          return;
        }

        const groupedItems = {};
        const itemsWithMetadata = [];
        const itemsInBundles = new Set();

        shopEntries.forEach((entry, entryIndex) => {
          let name = "Neznamy item";
          let image = "https://fortnite-api.com/images/vbucks.png";
          let price = entry.finalPrice || "???";
          let artist = "";
          let type = "other";
          let rarity = null;

          if (entry.tracks && entry.tracks.length > 0) {
            const track = entry.tracks[0];
            name = cleanItemName(track.title || "Neznamy Jam Track");
            artist = track.artist || "";
            image = track.albumArt || image;
            type = "tracks";
          } else if (entry.bundle) {
            name = cleanItemName(entry.bundle.name || "Neznamy Bundle");
            image = entry.bundle.image || image;
            type = "bundle";
            
            if (entry.bundle.items && entry.bundle.items.length > 0) {
              entry.bundle.items.forEach(bundleItem => {
                if (bundleItem.id) {
                  itemsInBundles.add(bundleItem.id);
                }
              });
            }
          } else {
            let itemId = entry.items?.[0]?.id || 
                        entry.brItems?.[0]?.id ||
                        entry.offerId;
            
            name = cleanItemName(entry.items?.[0]?.name || entry.devName || "Neznamy item");

            if (itemId && cosmeticsMap.has(itemId)) {
              const cosmeticDetails = cosmeticsMap.get(itemId);
              
              image = cosmeticDetails.images?.featured ||
                      cosmeticDetails.images?.icon ||
                      cosmeticDetails.images?.smallIcon ||
                      image;
              
              if (name === "Unnamed" || name === "Neznamy item") {
                name = cleanItemName(cosmeticDetails.name || name);
              }

              if (cosmeticDetails.type?.value) {
                type = cosmeticDetails.type.value.toLowerCase();
              }
              
              if (cosmeticDetails.rarity?.value) {
                rarity = cosmeticDetails.rarity.value.toLowerCase();
              }
            } else {
              image = entry.newDisplayAsset?.renderImages?.[0]?.image ||
                      entry.newDisplayAsset?.materialInstances?.[0]?.images?.Background ||
                      entry.displayAssets?.[0]?.full_background ||
                      image;
            }
          }

          if (!groupedItems[type]) {
            groupedItems[type] = [];
          }
          
          const itemData = {
            name: name,
            image: image,
            price: price,
            artist: artist,
            rarity: rarity,
            entryIndex: entryIndex,
            layoutId: entry.layout?.id,
            layoutName: entry.layout?.name,
            itemId: entry.items?.[0]?.id || entry.brItems?.[0]?.id || entry.offerId,
            description: type !== 'bundle' && type !== 'tracks' ? getItemDescription(entry, cosmeticsMap) : ''
          };
          
          // Debug pre "Beef Boss"
          if (name.includes('Beef Boss')) {
            console.log('=== BEEF BOSS DEBUG ===');
            console.log('Entry:', entry);
            console.log('Entry.items:', entry.items);
            console.log('Entry.items length:', entry.items?.length);
            console.log('Description:', itemData.description);
          }
          
          groupedItems[type].push(itemData);
          itemsWithMetadata.push({...itemData, type: type, entry: entry});
        });

        const { sets, itemsInSets, collections } = groupItemsIntoSets(groupedItems, shopEntries);

        const validCollections = Object.keys(collections).filter(colId => 
          collections[colId].items.length >= 2
        );

        const nonTracksCollections = [];
        const tracksCollections = [];
        
        validCollections.forEach(colId => {
          const collection = collections[colId];
          const isTracksCollection = collection.items.some(({ entry }) => 
            entry.tracks && entry.tracks.length > 0
          );
          
          if (isTracksCollection) {
            tracksCollections.push(colId);
          } else {
            nonTracksCollections.push(colId);
          }
        });

        if (nonTracksCollections.length > 0) {
          nonTracksCollections.forEach(collectionId => {
            const collection = collections[collectionId];
            const collectionDiv = document.createElement('div');
            collectionDiv.className = 'group';

            const collectionTitle = document.createElement('div');
            collectionTitle.className = 'group-title';
            collectionTitle.innerHTML = `${collection.name} <span class="count">(${collection.items.length})</span>`;
            collectionDiv.appendChild(collectionTitle);

            const collectionGridDiv = document.createElement('div');
            collectionGridDiv.className = 'items-grid';

            collection.items.forEach(({ entryIndex }) => {
              const itemData = itemsWithMetadata.find(item => item.entryIndex === entryIndex);
              if (!itemData) return;

              const itemDiv = document.createElement('div');
              itemDiv.className = 'item';
              if (itemData.rarity) {
                itemDiv.setAttribute('data-rarity', itemData.rarity);
              }

              const artistHtml = itemData.artist ? `<div class="item-artist">${itemData.artist}</div>` : '';
              const descriptionHtml = itemData.description ? `<div class="item-description">${itemData.description}</div>` : '';

              itemDiv.innerHTML = `
                <img src="${itemData.image}" alt="${itemData.name}">
                <div class="item-name">${itemData.name}</div>
                ${artistHtml}
                ${descriptionHtml}
                <div class="item-price">
                  ${itemData.price}
                  <img src="https://fortnite-api.com/images/vbuck.png" alt="V-Bucks">
                </div>
              `;
              collectionGridDiv.appendChild(itemDiv);
            });

            collectionDiv.appendChild(collectionGridDiv);
            shopContainer.appendChild(collectionDiv);
          });
        }

        if (Object.keys(sets).length > 0) {
          const setsGroupDiv = document.createElement('div');
          setsGroupDiv.className = 'group';

          const setsTitle = document.createElement('div');
          setsTitle.className = 'group-title';
          setsTitle.innerHTML = `Sets <span class="count">(${Object.keys(sets).length})</span>`;
          setsGroupDiv.appendChild(setsTitle);

          const setsGridDiv = document.createElement('div');
          setsGridDiv.className = 'items-grid';

          Object.keys(sets).sort().forEach(setName => {
            sets[setName].forEach(item => {
              const itemDiv = document.createElement('div');
              itemDiv.className = 'item';
              if (item.rarity) {
                itemDiv.setAttribute('data-rarity', item.rarity);
              }

              const artistHtml = item.artist ? `<div class="item-artist">${item.artist}</div>` : '';
              const descriptionHtml = item.description ? `<div class="item-description">${item.description}</div>` : '';

              itemDiv.innerHTML = `
                <img src="${item.image}" alt="${item.name}">
                <div class="item-name">${item.name}</div>
                ${artistHtml}
                ${descriptionHtml}
                <div class="item-price">
                  ${item.price}
                  <img src="https://fortnite-api.com/images/vbuck.png" alt="V-Bucks">
                </div>
              `;
              setsGridDiv.appendChild(itemDiv);
            });
          });

          setsGroupDiv.appendChild(setsGridDiv);
          shopContainer.appendChild(setsGroupDiv);
        }

        const typeOrder = ['outfit', 'backpack', 'pickaxe', 'glider', 'wrap', 'sidekick', 'shoes', 'kicks', 'emote', 'emoji', 'spray', 'loadingscreen', 'contrail', 'music', 'banner', 'toy', 'pet', 'itemwrap', 'aura', 'guitar', 'bass', 'drum', 'microphone', 'keytar', 'bundle', 'other', 'tracks'];

        typeOrder.forEach(type => {
          if (groupedItems[type] && groupedItems[type].length > 0) {
            const itemsNotInSets = groupedItems[type].filter((item, index) => {
              if (itemsInSets.has(`${type}-${index}`)) return false;
              if (type !== 'bundle' && type !== 'tracks' && item.itemId && itemsInBundles.has(item.itemId)) return false;
              if (item.layoutId && validCollections.includes(item.layoutId)) return false;
              return true;
            });
            
            if (itemsNotInSets.length === 0) return;
            
            const groupDiv = document.createElement('div');
            groupDiv.className = 'group';

            const groupTitle = document.createElement('div');
            groupTitle.className = 'group-title';
            groupTitle.innerHTML = `${TYPE_NAMES[type] || type} <span class="count">(${itemsNotInSets.length})</span>`;
            groupDiv.appendChild(groupTitle);

            const gridDiv = document.createElement('div');
            gridDiv.className = 'items-grid';

            itemsNotInSets.forEach(item => {
              const itemDiv = document.createElement('div');
              itemDiv.className = 'item';
              if (item.rarity) {
                itemDiv.setAttribute('data-rarity', item.rarity);
              }

              const artistHtml = item.artist ? `<div class="item-artist">${item.artist}</div>` : '';
              const descriptionHtml = item.description ? `<div class="item-description">${item.description}</div>` : '';

              itemDiv.innerHTML = `
                <img src="${item.image}" alt="${item.name}">
                <div class="item-name">${item.name}</div>
                ${artistHtml}
                ${descriptionHtml}
                <div class="item-price">
                  ${item.price}
                  <img src="https://fortnite-api.com/images/vbuck.png" alt="V-Bucks">
                </div>
              `;
              gridDiv.appendChild(itemDiv);
            });

            groupDiv.appendChild(gridDiv);
            shopContainer.appendChild(groupDiv);
          }
        });

        // Nakoniec renderujeme tracks kolekcie - úplne na konci
        if (tracksCollections.length > 0) {
          tracksCollections.forEach(collectionId => {
            const collection = collections[collectionId];
            const collectionDiv = document.createElement('div');
            collectionDiv.className = 'group';

            const collectionTitle = document.createElement('div');
            collectionTitle.className = 'group-title';
            collectionTitle.innerHTML = `${collection.name} <span class="count">(${collection.items.length})</span>`;
            collectionDiv.appendChild(collectionTitle);

            const collectionGridDiv = document.createElement('div');
            collectionGridDiv.className = 'items-grid';

            collection.items.forEach(({ entryIndex }) => {
              const itemData = itemsWithMetadata.find(item => item.entryIndex === entryIndex);
              if (!itemData) return;

              const itemDiv = document.createElement('div');
              itemDiv.className = 'item';
              if (itemData.rarity) {
                itemDiv.setAttribute('data-rarity', itemData.rarity);
              }

              const artistHtml = itemData.artist ? `<div class="item-artist">${itemData.artist}</div>` : '';
              const descriptionHtml = itemData.description ? `<div class="item-description">${itemData.description}</div>` : '';

              itemDiv.innerHTML = `
                <img src="${itemData.image}" alt="${itemData.name}">
                <div class="item-name">${itemData.name}</div>
                ${artistHtml}
                ${descriptionHtml}
                <div class="item-price">
                  ${itemData.price}
                  <img src="https://fortnite-api.com/images/vbuck.png" alt="V-Bucks">
                </div>
              `;
              collectionGridDiv.appendChild(itemDiv);
            });

            collectionDiv.appendChild(collectionGridDiv);
            shopContainer.appendChild(collectionDiv);
          });
        }

      } catch (err) {
        console.error("Chyba:", err);
        shopContainer.innerHTML = `<p class="error">Nepodarilo sa nacitat data.<br>${err.message}</p>`;
      }
    }

    loadData();
  </script>
</body>
</html>

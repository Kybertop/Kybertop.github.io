<!-- ===== JEDÁLNY LÍSTOK – VŠETKO V JEDNOM BLOKU ===== -->
<section id="menu" data-page class="hide">
  <div class="section-title">
    <h2>Jedálny lístok</h2>
    <div class="toolbar">
      <time id="menuUpdated" class="muted tiny" datetime="">Aktualizované — …</time>
    </div>
  </div>

  <div class="card menu-card" id="menuCard" aria-labelledby="menuTitle">
    <figure class="menu-figure" id="menuFigure">
      <img id="menuImg" class="menu-img" alt="Jedálny lístok" loading="lazy" decoding="async">
    </figure>

    <div class="actions">
      <button class="btn small" id="menuZoom" type="button">Zväčšiť</button>
      <a class="btn ghost" id="menuOpenFull" href="/assets/menu.jpg" target="_blank" rel="noopener">Otvoriť originál</a>
    </div>
  </div>
</section>

<!-- Lightbox (modal) -->
<div class="menu-lightbox" id="menuLightbox" role="dialog" aria-modal="true" aria-label="Zväčšený jedálny lístok">
  <div class="menu-lightbox__inner">
    <button class="menu-lightbox__close" id="menuLbClose" type="button">✕</button>
    <div class="menu-viewport" id="menuViewport">
      <img class="menu-full" id="menuFull" alt="">
    </div>
    <div class="menu-help muted tiny">Klik = +15 % • Alt/Right-click = −15 % • Koliesko = zoom • Ťah = posun • Esc = zavrieť</div>
  </div>
</div>

<style>
/* ===== Jedálny lístok – doplnkové štýly (scoped) ===== */
.menu-card{ position:relative; will-change:transform;
  transform:perspective(900px) rotateX(0deg) rotateY(0deg) translateZ(0);
  transition:transform .22s cubic-bezier(.2,.6,.2,1), box-shadow .22s; }
.menu-card::after{
  content:""; position:absolute; inset:-1px; border-radius:var(--radius); pointer-events:none;
  background:radial-gradient(320px 200px at calc(50% + var(--sheen-x,0px)) calc(50% + var(--sheen-y,0px)),
    rgba(255,255,255,.10), rgba(255,255,255,0) 60%);
  opacity:var(--sheen-opacity,0); mix-blend-mode:screen; transition:opacity .25s;
}
.menu-figure{ position:relative; overflow:hidden; border-radius:12px; background:#0f0f11; }
.menu-img{ width:100%; height:auto; display:block; cursor:zoom-in; image-rendering:auto; }

/* shimmer počas načítania */
.menu-figure::after{
  content:""; position:absolute; inset:0;
  background:linear-gradient(90deg,rgba(255,255,255,0),rgba(255,255,255,.08),rgba(255,255,255,0));
  transform:translateX(-100%); animation:menuShimmer 1.1s infinite; pointer-events:none;
}
.menu-figure.loaded::after{ display:none; }
@keyframes menuShimmer{ to{ transform:translateX(100%); } }

/* Modal (lightbox) */
.menu-lightbox{ position:fixed; inset:0; display:none; place-items:center; z-index:51;
  background:rgba(0,0,0,.76); backdrop-filter:blur(2px); }
.menu-lightbox.open{ display:grid; }
.menu-lightbox__inner{ position:relative; width:min(95vw,1200px); max-height:92vh;
  display:grid; grid-template-rows: auto 1fr auto; gap:8px; }
.menu-lightbox__close{ position:absolute; top:8px; right:8px; border:none; cursor:pointer;
  border-radius:10px; padding:6px 10px; background:rgba(0,0,0,.45); color:#fff; font-weight:800; }
.menu-lightbox__close:focus-visible{ outline:2px solid var(--accent); outline-offset:2px; }

.menu-viewport{
  position:relative; overflow:hidden; border-radius:16px; background:#0f0f11;
  width:100%; height:min(80vh, calc(92vh - 40px)); touch-action:none; /* pre pekný pan/zoom */
}
.menu-full{
  position:absolute; top:0; left:0; will-change:transform;
  transform-origin:0 0; /* spravíme si vlastnú kotvu */
  user-select:none; -webkit-user-drag:none; image-rendering:auto;
}
.menu-help{ text-align:center; }

/* mobil: vycentruj akcie pod obrázkom */
@media (max-width:640px){ .menu-card .actions{ justify-content:center; } }
@media (prefers-reduced-motion:reduce){ .menu-card{transition:none} .menu-card::after{display:none} }
</style>

<script>
(function(){
  /* ===== ZÁKLADNÉ PREMENNÉ ===== */
  const today   = new Date().toISOString().slice(0,10);
  const baseImg = '/assets/menu.jpg';
  const metaUrl = baseImg + '.json';

  const img       = document.getElementById('menuImg');
  const fig       = document.getElementById('menuFigure');
  const updatedEl = document.getElementById('menuUpdated');
  const openFull  = document.getElementById('menuOpenFull');
  const zoomBtn   = document.getElementById('menuZoom');

  /* ===== NAČÍTANIE OBRÁZKA + METADÁTA ===== */
  img.src = baseImg + '?v=' + today;
  function markLoaded(){ fig.classList.add('loaded'); }
  if (img.complete) markLoaded(); else img.addEventListener('load', markLoaded);
  img.addEventListener('error', ()=>{ markLoaded(); img.alt = 'Nepodarilo sa načítať jedálny lístok.'; });

  fetch(metaUrl, { cache:'no-store' })
    .then(r=>r.ok?r.json():null)
    .then(d=>{
      const full = (d && d.img) ? d.img : baseImg;
      const dt   = new Date((d && d.fetchedAt) || Date.now());
      updatedEl.dateTime   = dt.toISOString();
      updatedEl.textContent= 'Aktualizované — ' + dt.toLocaleString('sk-SK',{dateStyle:'medium', timeStyle:'short'});
      openFull.href        = full + '?v=' + today;
      img.dataset.full     = full + '?v=' + today;
    })
    .catch(()=>{ img.dataset.full = baseImg + '?v=' + today; });

  /* ===== MODAL + ZOOM/DRAG ===== */
  const lb       = document.getElementById('menuLightbox');
  const lbImg    = document.getElementById('menuFull');
  const lbClose  = document.getElementById('menuLbClose');
  const viewport = document.getElementById('menuViewport');

  // stav transformácie (scale + posun)
  const state = { scale: 1, minScale: 1, maxScale: 8, tx: 0, ty: 0, vw: 0, vh: 0, iw: 0, ih: 0 };

  function fitToScreen(){
    // nastavíme tak, aby sa celý obrázok zmestil do viewportu (contain)
    state.vw = viewport.clientWidth;
    state.vh = viewport.clientHeight;
    state.iw = lbImg.naturalWidth || lbImg.width;
    state.ih = lbImg.naturalHeight|| lbImg.height;

    const sx = state.vw / state.iw;
    const sy = state.vh / state.ih;
    state.minScale = Math.min(sx, sy);     // fit-contain
    state.scale    = state.minScale;
    state.tx = (state.vw - state.iw * state.scale) * 0.5; // centrovanie
    state.ty = (state.vh - state.ih * state.scale) * 0.5;
    applyTransform();
  }

  function applyTransform(){
    lbImg.style.transform = `translate(${state.tx}px, ${state.ty}px) scale(${state.scale})`;
  }

  // výpočet zoomu „na bod“ – aby kliknutý bod zostal na rovnakom mieste
  function zoomAt(cx, cy, factor){
    const newScale = Math.min(state.maxScale, Math.max(state.minScale, state.scale * factor));
    const k = newScale / state.scale;
    if (newScale === state.scale) return;

    // súradnice obrázka v obsahových jednotkách
    const imgX = (cx - state.tx) / state.scale;
    const imgY = (cy - state.ty) / state.scale;

    // nový posun tak, aby bod ostal fixovaný pod kurzorom
    state.tx = cx - imgX * newScale;
    state.ty = cy - imgY * newScale;
    state.scale = newScale;
    clampPan();
    applyTransform();
  }

  function clampPan(){
    // nech nedovolíme „utiecť“ obrázku ďaleko pri veľkom zoome
    const w = state.iw * state.scale;
    const h = state.ih * state.scale;

    const minTx = Math.min(0, state.vw - w);
    const maxTx = Math.max(0, state.vw - w);
    const minTy = Math.min(0, state.vh - h);
    const maxTy = Math.max(0, state.vh - h);

    // ak je obrázok menší ako viewport – centrovať
    state.tx = (w < state.vw) ? (state.vw - w) * 0.5 : Math.min(0, Math.max(minTx, state.tx));
    state.ty = (h < state.vh) ? (state.vh - h) * 0.5 : Math.min(0, Math.max(minTy, state.ty));
  }

  function openLB(){
    lbImg.src = img.dataset.full || img.src;
    lb.classList.add('open');
    lbClose.focus();

    // Po načítaní originálu prispôsob view
    if (lbImg.complete) { fitToScreen(); }
    else lbImg.onload = fitToScreen;
  }
  function closeLB(){
    lb.classList.remove('open');
    lbImg.src = '';
  }

  // klik v náhľade otvára modal
  img.addEventListener('click', openLB);
  document.getElementById('menuZoom').addEventListener('click', openLB);
  lb.addEventListener('click', e=>{ if (e.target === lb) closeLB(); });
  lbClose.addEventListener('click', closeLB);
  document.addEventListener('keydown', e=>{ if (e.key === 'Escape' && lb.classList.contains('open')) closeLB(); });

  // zoom interakcie v modale
  const Z = 1.15; // 15 %
  viewport.addEventListener('click', e=>{
    // Alt/Right-click = zoom out, inak zoom in
    const factor = (e.altKey || e.button===2) ? (1/Z) : Z;
    zoomAt(e.clientX - viewport.getBoundingClientRect().left,
           e.clientY - viewport.getBoundingClientRect().top, factor);
  });
  // potlač context menu (kvôli right-click zoom out)
  viewport.addEventListener('contextmenu', e=>e.preventDefault());

  // koliesko = zoom (s „na bod“)
  viewport.addEventListener('wheel', e=>{
    e.preventDefault();
    const factor = (e.deltaY > 0) ? (1/Z) : Z;
    zoomAt(e.clientX - viewport.getBoundingClientRect().left,
           e.clientY - viewport.getBoundingClientRect().top, factor);
  }, { passive:false });

  // pan (ťahanie) keď je priblížené
  let panning = false, sx=0, sy=0, startTx=0, startTy=0;
  function startPan(x,y){ panning=true; sx=x; sy=y; startTx=state.tx; startTy=state.ty; }
  function movePan(x,y){
    if(!panning) return;
    state.tx = startTx + (x - sx);
    state.ty = startTy + (y - sy);
    clampPan(); applyTransform();
  }
  function endPan(){ panning=false; }

  // myš
  viewport.addEventListener('mousedown', e=>{ startPan(e.clientX, e.clientY); });
  window.addEventListener('mousemove', e=>movePan(e.clientX, e.clientY));
  window.addEventListener('mouseup', endPan);

  // dotyk
  viewport.addEventListener('pointerdown', e=>{ viewport.setPointerCapture(e.pointerId); startPan(e.clientX, e.clientY); });
  viewport.addEventListener('pointermove', e=>movePan(e.clientX, e.clientY));
  viewport.addEventListener('pointerup',   endPan);
  viewport.addEventListener('pointercancel', endPan);
  window.addEventListener('resize', ()=>{ if(lb.classList.contains('open')) fitToScreen(); });

  /* ===== Jemný tilt na desktope (znížený) ===== */
  const card = document.getElementById('menuCard');
  const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const isCoarse       = window.matchMedia('(pointer: coarse)').matches;
  if (card && !prefersReduced && !isCoarse){
    const MAX = 1.1;  // mierne
    const SHEEN = 6;
    let rafId = 0;
    function applyTilt(rx,ry,sx,sy,show){
      cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(()=>{
        card.style.transform = `perspective(900px) rotateX(${ry.toFixed(2)}deg) rotateY(${rx.toFixed(2)}deg) translateZ(0)`;
        card.style.setProperty('--sheen-x', `${sx.toFixed(1)}px`);
        card.style.setProperty('--sheen-y', `${sy.toFixed(1)}px`);
        card.style.setProperty('--sheen-opacity', show ? '1' : '0');
      });
    }
    function resetTilt(){ applyTilt(0,0,0,0,0); }
    card.addEventListener('pointermove', e=>{
      const r = card.getBoundingClientRect();
      const px = (e.clientX - r.left) / r.width;
      const py = (e.clientY - r.top)  / r.height;
      applyTilt((px-.5)*(MAX*2), (0.5-py)*(MAX*2), (px-.5)*SHEEN, (py-.5)*SHEEN, 1);
    });
    card.addEventListener('pointerleave', resetTilt);
  }
})();
</script>

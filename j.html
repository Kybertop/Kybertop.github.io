<!-- ===== JEDÁLNY LÍSTOK (wheel-zoom only) ===== -->
<section id="menu" data-page class="hide">
  <div class="section-title">
    <h2>Jedálny lístok</h2>
    <div class="toolbar"><time id="menuUpdated" class="muted tiny" datetime="">Aktualizované — …</time></div>
  </div>

  <div class="card menu-card" id="menuCard" aria-labelledby="menuTitle">
    <figure class="menu-figure" id="menuFigure">
      <img id="menuImg" class="menu-img" alt="Jedálny lístok" loading="lazy" decoding="async">
    </figure>
    <div class="actions">
      <button class="btn small" id="menuZoom" type="button">Zväčšiť</button>
      <a class="btn ghost" id="menuOpenFull" href="/assets/menu.jpg" target="_blank" rel="noopener">Otvoriť originál</a>
    </div>
  </div>
</section>

<!-- Modal -->
<div class="menu-lightbox" id="menuLightbox" role="dialog" aria-modal="true" aria-label="Zväčšený jedálny lístok">
  <div class="menu-lightbox__inner">
    <button class="menu-lightbox__close" id="menuLbClose" type="button">✕</button>
    <div class="menu-viewport" id="menuViewport">
      <img class="menu-full" id="menuFull" alt="">
    </div>
    <div class="menu-help muted tiny">Koliesko myši = zoom • Esc = zavrieť</div>
  </div>
</div>

<style>
/* scoped štýly – nič iné ti nerozbijú */
.menu-card{position:relative;will-change:transform;
  transform:perspective(900px) rotateX(0deg) rotateY(0deg) translateZ(0);
  transition:transform .22s cubic-bezier(.2,.6,.2,1), box-shadow .22s;}
.menu-card::after{content:"";position:absolute;inset:-1px;border-radius:var(--radius);pointer-events:none;
  background:radial-gradient(320px 200px at calc(50% + var(--sheen-x,0px)) calc(50% + var(--sheen-y,0px)),
  rgba(255,255,255,.10), rgba(255,255,255,0) 60%);opacity:var(--sheen-opacity,0);mix-blend-mode:screen;transition:opacity .25s;}
.menu-figure{position:relative;overflow:hidden;border-radius:12px;background:#0f0f11;}
.menu-img{width:100%;height:auto;display:block;cursor:zoom-in;}
.menu-figure::after{content:"";position:absolute;inset:0;
  background:linear-gradient(90deg,rgba(255,255,255,0),rgba(255,255,255,.08),rgba(255,255,255,0));
  transform:translateX(-100%);animation:menuShimmer 1.1s infinite;pointer-events:none;}
.menu-figure.loaded::after{display:none;}
@keyframes menuShimmer{to{transform:translateX(100%)}}

.menu-lightbox{position:fixed;inset:0;display:none;place-items:center;z-index:51;
  background:rgba(0,0,0,.76);backdrop-filter:blur(2px);}
.menu-lightbox.open{display:grid;}
.menu-lightbox__inner{position:relative;width:min(95vw,1200px);max-height:92vh;
  display:grid;grid-template-rows:auto 1fr auto;gap:8px;}
.menu-lightbox__close{position:absolute;top:8px;right:8px;border:none;cursor:pointer;border-radius:10px;
  padding:6px 10px;background:rgba(0,0,0,.45);color:#fff;font-weight:800;}
.menu-viewport{position:relative;overflow:hidden;border-radius:16px;background:#0f0f11;
  width:100%;height:min(80vh,calc(92vh - 40px));}
.menu-full{position:absolute;top:0;left:0;will-change:transform;transform-origin:0 0;user-select:none;-webkit-user-drag:none;}
.menu-help{text-align:center;}
@media(max-width:640px){.menu-card .actions{justify-content:center}}
@media(prefers-reduced-motion:reduce){.menu-card{transition:none}.menu-card::after{display:none}}
</style>

<script>
(function(){
  const today = new Date().toISOString().slice(0,10);
  const base  = '/assets/menu.jpg';
  const meta  = base + '.json';

  const img = document.getElementById('menuImg');
  const fig = document.getElementById('menuFigure');
  const updated = document.getElementById('menuUpdated');
  const aFull = document.getElementById('menuOpenFull');
  const btnOpen = document.getElementById('menuZoom');

  // náhľad + metadáta
  img.src = base + '?v=' + today;
  const done = ()=>fig.classList.add('loaded');
  if (img.complete) done(); else img.addEventListener('load', done);
  img.addEventListener('error', ()=>{ done(); img.alt='Nepodarilo sa načítať jedálny lístok.'; });

  fetch(meta,{cache:'no-store'}).then(r=>r.ok?r.json():null).then(d=>{
    const full = d?.img || base;
    const dt = new Date(d?.fetchedAt || Date.now());
    updated.dateTime = dt.toISOString();
    updated.textContent = 'Aktualizované — ' + dt.toLocaleString('sk-SK',{dateStyle:'medium',timeStyle:'short'});
    aFull.href = full + '?v=' + today;
    img.dataset.full = full + '?v=' + today;
  }).catch(()=>{ img.dataset.full = base + '?v=' + today; });

  // modal
  const lb = document.getElementById('menuLightbox');
  const lbImg = document.getElementById('menuFull');
  const lbClose = document.getElementById('menuLbClose');
  const viewport = document.getElementById('menuViewport');

  // stav zoomu (len wheel)
  const S = { scale:1, min:1, max:8, tx:0, ty:0, vw:0, vh:0, iw:0, ih:0 };

  function fit(){
    S.vw = viewport.clientWidth; S.vh = viewport.clientHeight;
    S.iw = lbImg.naturalWidth || lbImg.width;
    S.ih = lbImg.naturalHeight|| lbImg.height;
    const sx = S.vw / S.iw, sy = S.vh / S.ih;
    S.min = Math.min(sx, sy); S.scale = S.min;
    S.tx = (S.vw - S.iw * S.scale) * .5;
    S.ty = (S.vh - S.ih * S.scale) * .5;
    apply();
  }
  function apply(){ lbImg.style.transform = `translate(${S.tx}px, ${S.ty}px) scale(${S.scale})`; }
  function clamp(){
    const w=S.iw*S.scale, h=S.ih*S.scale;
    S.tx = (w<S.vw) ? (S.vw-w)/2 : Math.min(0, Math.max(S.vw-w, S.tx));
    S.ty = (h<S.vh) ? (S.vh-h)/2 : Math.min(0, Math.max(S.vh-h, S.ty));
  }
  function zoomAt(x,y,fac){
    const ns = Math.min(S.max, Math.max(S.min, S.scale*fac));
    if (ns===S.scale) return;
    const imgX=(x-S.tx)/S.scale, imgY=(y-S.ty)/S.scale;
    S.tx = x - imgX*ns; S.ty = y - imgY*ns; S.scale = ns; clamp(); apply();
  }

  function open(){
    lbImg.src = img.dataset.full || img.src;
    lb.classList.add('open'); lbClose.focus();
    if (lbImg.complete) fit(); else lbImg.onload = fit;
  }
  function close(){ lb.classList.remove('open'); lbImg.src=''; }

  img.addEventListener('click', open);
  btnOpen.addEventListener('click', open);
  lbClose.addEventListener('click', close);
  lb.addEventListener('click', e=>{ if(e.target===lb) close(); });
  document.addEventListener('keydown', e=>{ if(e.key==='Escape' && lb.classList.contains('open')) close(); });
  window.addEventListener('resize', ()=>{ if(lb.classList.contains('open')) fit(); });

  // wheel-zoom (±15 %) okolo kurzora
  const STEP = 1.15;
  viewport.addEventListener('wheel', e=>{
    e.preventDefault();
    const r = viewport.getBoundingClientRect();
    const x = e.clientX - r.left, y = e.clientY - r.top;
    zoomAt(x, y, e.deltaY>0 ? 1/STEP : STEP);
  }, { passive:false });

  // jemný tilt na desktope (znížený)
  const card = document.getElementById('menuCard');
  const reduce = matchMedia('(prefers-reduced-motion: reduce)').matches;
  const coarse = matchMedia('(pointer: coarse)').matches;
  if(card && !reduce && !coarse){
    const MAX=1.1, SHEEN=6; let raf=0;
    function tilt(rx,ry,sx,sy,show){
      cancelAnimationFrame(raf);
      raf=requestAnimationFrame(()=>{
        card.style.transform=`perspective(900px) rotateX(${ry.toFixed(2)}deg) rotateY(${rx.toFixed(2)}deg) translateZ(0)`;
        card.style.setProperty('--sheen-x',`${sx.toFixed(1)}px`);
        card.style.setProperty('--sheen-y',`${sy.toFixed(1)}px`);
        card.style.setProperty('--sheen-opacity',show?'1':'0');
      });
    }
    function reset(){ tilt(0,0,0,0,0); }
    card.addEventListener('pointermove', e=>{
      const r=card.getBoundingClientRect(), px=(e.clientX-r.left)/r.width, py=(e.clientY-r.top)/r.height;
      tilt((px-.5)*(MAX*2),(0.5-py)*(MAX*2),(px-.5)*SHEEN,(py-.5)*SHEEN,1);
    });
    card.addEventListener('pointerleave', reset);
  }
})();
</script>
